---
  - hosts: ans-db-group
    become: true
    tasks:
    ###################################
    # Install Mysql 
    # ---------------------------------
    - name: Inastall mysql-server
      yum: name={{item}} state=latest
      with_items:
        - mariadb
        - mariadb-server
        - MySQL-python
        - rsync

    - name: Start Mysql server
      systemd: 
        state: started
        name: mariadb
    
    ##################################
    # Manage Mysql users
    # --------------------------------
    - name: Removing anonymous users
      mysql_user:
        name: ''
        host_all: yes
        state: absent

    - name: Create Mysql user
      mysql_user: 
        name: ansible
        password: ansible
        priv: '*.*:ALL'
        state: present

  #######################################
  # Move database from app-svr to db-svr
  # -------------------------------------
  
  - hosts: ans-app-group
    become: true
    tasks:
    - name: get database from app-svr app repo
      fetch: 
        src: /var/www/html/elycee/db_elycee.sql
        dest: /tmp/ansible/db_elycee.sql 

  - hosts: ans-db-group
    become: true
    tasks:

    - name: Create destination folder for db
      file: 
        path: '/tmp/{{item}}'
        state: directory
        mode: 0755
      with_items:
        - ansible
        - db_ansible

    - name: send database to db-svr 
      copy: 
        src: /tmp/ansible/db_elycee.sql
        dest: /tmp/ansible/db_elycee.sql


  ######################################
  # Manage Mysql database
  # ------------------------------------
  - hosts: ans-db-group
    become: true
    tasks:

    - name: Prepare database to import
      shell: find -type f -name db_elycee.sql | xargs cp -u -t /tmp/db_ansible/
      args:
        chdir: /tmp/ansible/

    - name: Create database
      mysql_db: 
        name: db_elycee
        state: present

    - name: Import Mysql database
      mysql_db:
        state: import
        name: db_elycee
        target: /tmp/db_ansible/db_elycee.sql


